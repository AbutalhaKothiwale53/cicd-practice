name: Node.js CI with Notifications, Caching, and Artifacts

on: [push, pull_request]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      # Caching node_modules
      - name: Cache dependencies
        uses: actions/cache@v4
        with:
          path: node_modules
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
          restore-keys: ${{ runner.os }}-node-

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm install

      - name: Run tests
        run: npm test

      # Upload code coverage results, if generated by tests
      - name: Upload code coverage
        uses: actions/upload-artifact@v4
        with:
          name: code-coverage
          path: coverage

      # Notify Slack on workflow success and failure (add if desired)
      - name: Slack notify on success
        if: success()
        env:
            SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
            curl -X POST -H 'Content-type: application/json' \
            --data '{"text":"✅ CI succeeded for '${{ github.repository }}'!"}' \
            $SLACK_WEBHOOK_URL
    
      - name: Slack notify on failure
        if: failure()
        env:
            SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
            curl -X POST -H 'Content-type: application/json' \
            --data '{"text":"❌ CI failed for '${{ github.repository }}'!"}' \
            $SLACK_WEBHOOK_URL
    


      # Send email (optional, needs SMTP setup)
    #   - name: Email notify on failure
    #     if: failure()
    #     uses: dawidd6/action-send-mail@v3
    #     with:
    #       server_address: smtp.gmail.com
    #       server_port: 465
    #       username: ${{ secrets.EMAIL_USERNAME }}
    #       password: ${{ secrets.EMAIL_PASSWORD }}
    #       subject: |
    #         ${GITHUB_REPOSITORY}: Workflow failed!
    #       to: your-team@email.com
    #       from: CICD Bot <your-bot@email.com>
    #       body: Build failed in job ${{ github.job }}, repo: ${{ github.repository }}
